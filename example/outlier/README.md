# 离群摘除端到端示例

## 概述

目的：构建用于测试离群摘除功能正确性的随机失败环境

方法：启动由10个节点构成的服务，每个节点用id编号，节点启动后的第10+5*id秒时开始出现故障，故障时间持续20s

- 为模拟节点的网络错误，故障时间段内对节点的RPC调用将会持续阻塞，直到故障恢复后才会返回；
- 为模拟节点的业务错误，故障时间段内对节点的RPC调用将会返回5XX错误，直到故障恢复后才返回正常。

## How to Run

在`example/outlier`目录中有三个微服务框架（go-micro、kitex和kratos）的示例代码。这些示例实现了一个简单的业务逻辑——`echo hello`程序，并利用了`etcd`作为注册中心。示例中不仅实现了服务端代码，在`client`目录中还实现了集成离群摘除功能的客户端代码。下文中我们将会用这份代码来随机模拟节点崩溃故障和业务故障，下面首先介绍如何使用这份示例程序。

1. 安装注册中心：请按照[etcd安装文档](https://etcd.io/docs/v3.5/install/)的说明安装etcd。

2. 启动注册中心：在本地启动etcd，默认情况下，etcd监听端口为2379。

3. 启动服务进程：通过运行`setup.sh`脚本来启动指定数量的服务进程并模拟相应的故障情景。脚本的第一个参数`node_crash`用于指示是否模拟节点崩溃场景，默认值为false，第二个参数`node_count`指定启动服务进程的数量，默认值为9。比如对于 go-micro 框架，通过下面命令可以启动4个服务进程并模拟节点崩溃：

   ```shell
   cd hello_micro && ./setup.sh true 4
   ```


4. 启动客户端进程：直接进入`client`目录中通过`go run .`启动客户端程序，客户端每隔500ms会发起一次服务调用，总共发起200次调用并记录正确返回的次数，用于评价离群摘除的实现效果。比如对于 go-micro 框架，客户端启动命令如下：

   ```shell
   cd hello_micro/client && go run .
   ```

## 模拟节点崩溃

当`node_crash=true`时模拟的便是节点崩溃的场景。首先启动`node_count`个服务节点，然后按照节点编号的顺序每隔5s杀死一个节点（kill掉节点进程），等到杀死所有节点后，再每隔5s按照节点编号的顺序以相同的端口重新启动节点。`setup.sh`脚本中主要实现了模拟节点崩溃相关的如下三个函数。

1. 启动进程 (`start_process`函数)：
   - 在循环中，根据`node_count`启动指定数量的服务进程，每个进程监听不同的端口（9001到9009）。
   - 使用`go run . --server_address=:$port`命令启动服务，并将进程ID存储在数组`pids`中。
2. 停止进程 (`stop_process`函数)：
   - 在循环中，等待5秒后，通过`kill`命令依次停止之前启动的服务进程。
   - 使用`pgrep -f "hello_micro --server_address=:$port" | xargs kill`确保杀死相关的进程。
3. 重启进程(`restart_process`函数)：
   - 在循环中，等待5秒后，重启之前停止的服务进程，使用相同的端口。

流程控制：先调用`start_process`函数启动所有服务进程，然后等待5秒后调用`stop_process`函数停止进程，然后调用`restart_process`函数重启它们。

## 模拟业务错误

### 模拟方式

当`node_crash=false`时模拟的便是业务故障的场景。首先启动`node_count`个服务节点，然后按照节点编号的顺序每隔5s让一个节点进入业务故障期，该时间持续20s，在此期间收到的所有客户端请求都会返回错误响应，等到节点度过业务故障时期后，将会重新返回正确的响应。示例代码目录下的`handler.go`文件代码模拟了业务错误的场景，具体实现逻辑如下。

1. TestHandler结构体：定义`TestHandler`结构体，包含节点的ID和启动时间，这两个参数是为了方便计算业务出现故障的时间区间。

2. TestHandler的Ping方法：实现`TestHandler`结构体的`Ping`方法以处理传入的请求并返回给客户端响应：

   - 如果nodeCrash为false，则根据节点的ID计算出业务错误的时间范围：

     - `faultStartTime`是当前节点的启动时间`s.startTime`加上5秒，再加上节点ID乘以5秒。

       ```
       faultStartTime := s.startTime.Add(5 * time.Second).Add(time.Duration(s.id) * 5 * time.Second)
       ```

     - 故障结束时间`faultEndTime`是`faultStartTime`加上20秒。

       ```
       faultEndTime := faultStartTime.Add(20 * time.Second)
       ```

   - 接着获取当前时间currentTime，并检查其是否在业务错误的时间范围内：

     - 如果当前时间在`faultStartTime`和`faultEndTime`之间，返回一个空结果并抛出`errors.New("internal server error")`。
     - 如果当前时间不在错误范围内，则返回节点的欢迎信息`fmt.Sprintf("Welcome, I am node%d", s.id)`。

### 测试结果


当服务进程处于业务故障时期，虽然其IP地址仍存在于客户端负载均衡列表中，对该节点的调用能够得到响应，但是这个响应不是200 OK而是包含服务端内部错误。所以我们希望能够借助离群摘除的能力，从负载均衡的列表中剔除这些业务故障的节点，从而提高服务调用的成功率。另一方面，我们也希望当节点业务恢复正常时，借助主动或者被动的恢复检测机制，能够及时将其加回到负载均衡列表中。

如下图所示，由于节点出现业务故障，不断摘除负载均衡列表中的异常节点。注意下图与模拟节点崩溃的场景不同的是，Filter Pre表示的过滤前的负载均衡列表，从始至终包含所有的9个节点的IP地址。所以如果没有Sentinel提供的客户端离群摘除的能力，单凭注册中心的离群摘除功能是不足以应对这种情况的，因为注册中心无法摘除仅仅是业务上出错的节点。

```
Filter Pre:  [10.113.43.181:9008 10.113.43.181:9009 10.113.43.181:9007 10.113.43.181:9005 10.113.43.181:9006 10.113.43.181:9003 10.113.43.181:9002 10.113.43.181:9004 10.113.43.181:9001]
Filter Post:  [10.113.43.181:9008 10.113.43.181:9009 10.113.43.181:9007 10.113.43.181:9005 10.113.43.181:9006 10.113.43.181:9003 10.113.43.181:9002 10.113.43.181:9004]
2024/10/14 14:07:14 <nil> rpc error: code = Unknown desc = internal server error
Filter Pre:  [10.113.43.181:9008 10.113.43.181:9009 10.113.43.181:9007 10.113.43.181:9005 10.113.43.181:9006 10.113.43.181:9003 10.113.43.181:9002 10.113.43.181:9004 10.113.43.181:9001]
Filter Post:  [10.113.43.181:9008 10.113.43.181:9009 10.113.43.181:9007 10.113.43.181:9005 10.113.43.181:9006 10.113.43.181:9003 10.113.43.181:9004]
```
如下图所示，触发了两次被动恢复检测，当节点熔断器处于半开状态时，会周期性放行探测请求，如果请求响应成功则认为节点恢复。下图中对node8的检测成功了，对node9的检测仍旧失败了，检测成功的节点将会在下一次服务调用的时候加入到负载均衡列表中。下图中Filter Post确实可以看到node8被加入到了过滤后的负载均衡列表中。
```
Half Filter Pre:  [10.113.43.181:9004 10.113.43.181:9006 10.113.43.181:9009 10.113.43.181:9001 10.113.43.181:9003 10.113.43.181:9007 10.113.43.181:9005 10.113.43.181:9008 10.113.43.181:9002]
Half Filter Post:  [10.113.43.181:9008]
2024/10/14 14:10:09 message:"Welcome Bob,I am node8" <nil>
Half Filter Pre:  [10.113.43.181:9004 10.113.43.181:9006 10.113.43.181:9009 10.113.43.181:9001 10.113.43.181:9003 10.113.43.181:9007 10.113.43.181:9005 10.113.43.181:9008 10.113.43.181:9002]
Half Filter Post:  [10.113.43.181:9009]
2024/10/14 14:10:09 <nil> rpc error: code = Unknown desc = internal server error
Filter Pre:  [10.113.43.181:9004 10.113.43.181:9006 10.113.43.181:9009 10.113.43.181:9001 10.113.43.181:9003 10.113.43.181:9007 10.113.43.181:9005 10.113.43.181:9008 10.113.43.181:9002]
Filter Post:  [10.113.43.181:9004 10.113.43.181:9006 10.113.43.181:9001 10.113.43.181:9003 10.113.43.181:9007 10.113.43.181:9005 10.113.43.181:9008 10.113.43.181:9002]
2024/10/14 14:10:10 message:"Welcome Bob,I am node1" <nil>
```